<!doctype>
<html>
<head>
	<meta charset="utf-8" />
	<style type="text/css">
	body {
	    background: black;
	}
	canvas {
	    position: absolute;
	    left: 0;
	    top: 0;
	    width: 100%;
	    height: 100%;
	}
	#menu {
	    position: absolute;
	    z-index: 99;
	}
	</style>
	<script type="text/javascript">

var wtf = new Object();

(function mySpirograph(){
    var width  = window.innerWidth;
    var height = window.innerHeight;
    var centerPoint = {x: width/2, y: height/2};
    var spiroLayer, circlesLayers;
    var curAngle = 0;
    var zIndex = 0;
    var speed;
    var intervalId;
    var R,r,d,s=1;
    var mouseDown;
    var p = {}, p_old = {};
    var playStopButton, showHideButton;
    var hideCirc;
    var mover;

    wtf.drawBigCir = function (){
        circlesLayers.save()
        circlesLayers.translate(centerPoint.x, centerPoint.y)
        circlesLayers.strokeStyle = "white"
        circlesLayers.beginPath()
        circlesLayers.arc(0, 0, R, 0, Math.PI*2,true)
        circlesLayers.stroke()
        circlesLayers.restore()
    }

    wtf.drawLittleCir = function (angle){
        curAngle = angle;

        circlesLayers.save()
        circlesLayers.translate(centerPoint.x, centerPoint.y)
        circlesLayers.strokeStyle = "white"
        circlesLayers.rotate(angle)
        circlesLayers.beginPath()
        circlesLayers.translate(R-r, 0)
        circlesLayers.arc(0, 0, r, 0, Math.PI*2,true)
        circlesLayers.stroke()
        circlesLayers.restore()

        circlesLayers.save()
        circlesLayers.strokeStyle = "red"
        circlesLayers.translate(centerPoint.x, centerPoint.y)

        circlesLayers.beginPath();
        circlesLayers.arc(p.x, p.y, 3, 0, Math.PI*2, true)
        circlesLayers.stroke()

        circlesLayers.restore()
    }

    wtf.drawSpiro = function(angle){
        spiroLayer.save()
        spiroLayer.translate(centerPoint.x, centerPoint.y)

        spiroLayer.strokeStyle = "#aaa";

        spiroLayer.beginPath()
        spiroLayer.moveTo(p_old.x, p_old.y);
        spiroLayer.lineTo(p.x, p.y);
        spiroLayer.stroke()

        spiroLayer.restore()
    }

    wtf.clearCircles = function () {
        circlesLayers.clearRect(0,0,width,height);
    }

    wtf.drawCirsOnly = function (){
        wtf.drawBigCir();
        wtf.drawLittleCir(curAngle);
    }

    wtf.redrawCirs = function (angle){
        p_old.x = p.x
        p_old.y = p.y

        p.x = (R-r)*Math.cos(angle) + d*Math.cos(-((R-r)/r)*angle);
        p.y = (R-r)*Math.sin(angle) + d*Math.sin(-((R-r)/r)*angle);

        wtf.clearCircles();
        if(!hideCirc){
            wtf.drawBigCir();
            wtf.drawLittleCir(angle);
        }
        wtf.drawSpiro(angle);
    }

    wtf.animateCirs = function (){
        if(!mouseDown){
            for(var i=0; i<s; i++){
                wtf.redrawCirs(Math.PI/60*speed);
                speed++;
            }
        }
    }

    wtf.stopAnimation = function (){
        clearInterval(intervalId);
        intervalId = false
    }
    
    wtf.playAnimation = function (){
        intervalId = setInterval("wtf.animateCirs()", 20);
    }

    wtf.toggleAnimation = function (){
        if(intervalId){
            playStopButton.src = 'spirograph_images/play.png'
            wtf.stopAnimation();

            wtf.drawBigCir();
            wtf.drawLittleCir(curAngle);
        }
        else {
            playStopButton.src = 'spirograph_images/stop.png'
            wtf.playAnimation()
        }
    }

    wtf.toggleCircs = function (){
        if(hideCirc){
            showHideButton.src = 'spirograph_images/hide_circ.png'
            hideCirc = false;
            wtf.drawCirsOnly();
        }
        else {
            showHideButton.src = 'spirograph_images/show_circ.png'
            hideCirc = true;
            wtf.clearCircles();
        }
    }

    wtf.alterValues = function (){
        R = parseInt(document.getElementById("R").value)
        r = parseInt(R * parseInt(document.getElementById("r").value)/100)
        d = parseInt(r * parseInt(document.getElementById("d").value)/100)
        s = parseInt(document.getElementById("s").value)

        p.x = (R-r)*Math.cos(curAngle) + d*Math.cos(-((R-r)/r)*curAngle);
        p.y = (R-r)*Math.sin(curAngle) + d*Math.sin(-((R-r)/r)*curAngle);
        
        wtf.clearCircles();
        wtf.drawCirsOnly();
    }

    wtf.moveCircs = function (){
        
    }

    window.onload = function(){
        spiroLayer = canvasFactory();
        circlesLayers = canvasFactory();

        playStopButton = document.getElementById('play_stop_button');
        showHideButton = document.getElementById('show_hide_button');

        wtf.alterValues()

        speed = 0;
        hideCirc = false;

        mover = document.getElementById('mover');

        mover.style.left = centerPoint.x - R - 32;
        mover.style.top = centerPoint.y - R;

        mover.onmousedown = dragCenter.startDrag;
    }

    var dragCenter = {

        iniMousePos:    {},
        startPos:       {},
        dragging:       null,

        startDrag: function (e) {
            dragCenter.startPos.x = this.offsetLeft;
            dragCenter.startPos.y = this.offsetTop;
            dragCenter.dragging = this;
            this.className += ' dragged';

            dragCenter.iniMousePos.x = e.clientX;
            dragCenter.iniMousePos.y = e.clientY;

            document.addEventListener('mousemove',  dragCenter.drag     , false);
            document.addEventListener('mouseup',    dragCenter.release  , false);

            mouseDown = true;

            return false;
        },

        drag: function (e) {
            var x = e.clientX - dragCenter.iniMousePos.x;
            var y = e.clientY - dragCenter.iniMousePos.y;

            dragCenter.setPos(x, y);
            wtf.clearCircles();
            wtf.drawCirsOnly();
            
            return false;
        },

        release: function () {
            document.removeEventListener('mousemove', dragCenter.drag, false);
            document.removeEventListener('mouseup', dragCenter.release, false);
            dragCenter.dragging.className = dragCenter.dragging.className.replace(/ dragged/, '');

            mouseDown = false;
            dragCenter.dragging = null;
        },

        setPos: function (x, y){
            dragCenter.dragging.style.left = dragCenter.startPos.x + x + 'px';
            dragCenter.dragging.style.top = dragCenter.startPos.y + y + 'px';

            centerPoint.x = dragCenter.startPos.x + x + R + 20;
            centerPoint.y = dragCenter.startPos.y + y + R;
        }
    };

    function canvasFactory(){
        var canvas = document.createElement("canvas");
        canvas.width  = width;
        canvas.height = height;
        canvas.style.zIndex = zIndex;
        zIndex++;

        document.body.appendChild(canvas);

        return canvas.getContext("2d");
    }

}())

	</script>
</head>

<body>
    <div id="menu">
        <input id="R" type="range" min="10" max="300" value="100" onchange="wtf.alterValues()"/>
        <input id="r" type="range" min="10" max="90" value="52" onchange="wtf.alterValues()"/>
        <input id="d" type="range" min="0" max="100" value="75" onchange="wtf.alterValues()"/>
        <input id="s" type="range" min="1" max="5" value="1" onchange="wtf.alterValues()"/>

        <img id="play_stop_button" onclick="wtf.toggleAnimation()" src="spirograph_images/play.png" />
        <img id="show_hide_button" onclick="wtf.toggleCircs()" src="spirograph_images/hide_circ.png" />
    </div>
    <div id="mover" style="background: url(spirograph_images/move.png);position: absolute; width: 32px; height: 32px; z-index: 9999; display: inline;"/>
</body>
</html>
